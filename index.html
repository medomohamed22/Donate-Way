<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>دفع بـ Pi Network - مثال</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: white;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 2.5rem 2rem;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    h1 { margin: 0.4em 0; font-size: 2.1rem; }
    .price { font-size: 2.8rem; font-weight: bold; margin: 0.6em 0; color: #bb86fc; }
    button {
      background: #bb86fc;
      color: black;
      border: none;
      padding: 16px 40px;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 6px 20px rgba(187,134,252,0.4);
      margin-top: 1.5rem;
    }
    button:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(187,134,252,0.55); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status {
      margin-top: 1.8rem;
      font-size: 1.1rem;
      min-height: 1.6em;
      color: #e0e0e0;
    }
    .error { color: #ff6b6b; }
  </style>
</head>
<body>

<div class="container">
  <h1>متجر بي مثالي</h1>
  <div class="price">٣٠٠ Pi</div>
  <p style="opacity:0.8; margin-bottom:1.5rem;">اشتراك شهري مميز</p>

  <button id="payButton" onclick="startPayment()">ادفع الآن بـ Pi</button>

  <div id="status">جاري الاتصال بـ Pi...</div>
</div>

<script>
// ────────────────────────────────────────────────
const paymentMemo = "اشتراك شهري مميز - مثال";
const paymentAmount = "300";       // ← غيّر الكمية هنا
const paymentMetadata = { plan: "premium_monthly", orderId: "test-001" };
// ────────────────────────────────────────────────

let paymentInProgress = false;

async function startPayment() {
  const btn = document.getElementById("payButton");
  const status = document.getElementById("status");

  if (paymentInProgress) return;
  paymentInProgress = true;
  btn.disabled = true;
  status.textContent = "جاري التحميل...";
  status.className = "";

  try {
    // 1. تهيئة Pi SDK
    if (!window.Pi) throw new Error("Pi SDK غير محمل");

    await Pi.init({ version: "2.0", sandbox: true }); // ← sandbox=true للتجربة

    // 2. تسجيل الدخول + طلب اسم المستخدم
    const scopes = ['username', 'payments'];
    const authResult = await Pi.authenticate(scopes, onIncompletePaymentFound);

    console.log("اسم المستخدم:", authResult.user.username);
    status.innerHTML = `مرحباً ${authResult.user.username} ✓<br>جاري بدء الدفع...`;

    // 3. إنشاء عملية الدفع
    const paymentData = {
      amount: paymentAmount,
      memo: paymentMemo,
      metadata: paymentMetadata
    };

    const payment = await Pi.createPayment(paymentData, {
      // ───── الدوال المهمة ─────
      onReadyForServerApproval: function(paymentId) {
        console.log("→ paymentId جاهز للموافقة من السيرفر:", paymentId);
        status.textContent = "بانتظار موافقة السيرفر...";
        // ← هنا ترسل paymentId للسيرفر الخاص بك (Node.js)
        notifyServerForApproval(paymentId, authResult.accessToken);
      },

      onReadyForServerCompletion: function(paymentId, txid) {
        console.log("→ الدفع مكتمل! txid:", txid);
        status.innerHTML = `تم الدفع بنجاح!<br>معرف المعاملة: ${txid}`;
        btn.disabled = false;
        paymentInProgress = false;
        // ← أخبر السيرفر أن العملية اكتملت
        notifyServerForCompletion(paymentId, txid, authResult.accessToken);
      },

      onCancel: function() {
        status.textContent = "تم إلغاء الدفع";
        paymentInProgress = false;
        btn.disabled = false;
      },

      onError: function(error) {
        status.textContent = "حصل خطأ: " + (error?.message || "غير معروف");
        status.className = "error";
        console.error(error);
        paymentInProgress = false;
        btn.disabled = false;
      }
    });

  } catch (err) {
    status.textContent = "خطأ في الاتصال: " + (err?.message || "");
    status.className = "error";
    console.error(err);
    paymentInProgress = false;
    btn.disabled = false;
  }
}

// مثال بسيط لإرسال إلى السيرفر (غيّر الرابط)
async function notifyServerForApproval(paymentId, accessToken) {
  try {
    await fetch('http://localhost:3000/approve-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId, accessToken })
    });
  } catch(e) {
    console.error("فشل إخطار السيرفر", e);
  }
}

async function notifyServerForCompletion(paymentId, txid, accessToken) {
  try {
    await fetch('http://localhost:3000/complete-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId, txid, accessToken })
    });
  } catch(e) {
    console.error("فشل إكمال السيرفر", e);
  }
}

// إذا وجد دفع غير مكتمل
function onIncompletePaymentFound(payment) {
  console.warn("وجد دفع سابق غير مكتمل:", payment);
  // يمكنك هنا إكمال أو إلغاء الدفع السابق
}
</script>
</body>
</html>
